# 멱등성 매커니즘 구현 해보기

## 멱등성이란?

- [MDN Web Docs 용어 사전: 웹 용어 정의 - 멱등성](https://developer.mozilla.org/ko/docs/Glossary/Idempotent)
- [Toss - 멱등성이 뭔가요?](https://blog.tossbusiness.com/articles/dev-1)
- [카카오페이 - MSA 환경에서 네트워크 예외를 잘 다루는 방법](https://tech.kakaopay.com/post/msa-transaction/)
- [위시켓 - 프로그래밍 용어 '멱등성(Idempotence)'알아보기](https://yozm.wishket.com/magazine/detail/2106/)
- [NHN Cloud Meetup - 지속 가능한 소프트웨어를 위한 코딩 방법 - 마지막 맺음말.](https://meetup.nhncloud.com/posts/218)
- [HTTP 메소드의 멱등성, 그리고 안전한 메서드](https://hudi.blog/http-method-idempotent/)

## 멱등성을 테스트 하기 위한 방법

- PUT, DELETE 요청시 idempotent 헤더를 추가하여 테스트
- 부하 테스트 용으로 증감에 대한 내용 테스트 추가

## 동시성 처리를 위한 방법

- Monolithic Application & Databasse
    - DB Lock
        - Row level Lock
            - 특정 레코드 락으로 최소한의 병목 현상을 유발
        - Isolation level
            - 격리 수준을 적절하게 설정하여 다른 트랜잭션과의 상호작용을 제어
    - JPA 사용시
        - 낙관적 락(Optimistic Lock)
            - @Version 어노테이션을 통해 엔티티에 버전 컬럼을 관리
            - 트랜잭션 충돌이 자주 발생하지 않는 경우 사용
            - 성능 향상
                - 레코드를 물리적으로 잠그는 것이 아니기 때문에, 동시에 여러 트랜잭션을 처리할 수 있으며, 성능 향상을 기대할 수 있음
                - 비관적 락과 달리 다른 트랜잭션이 대기 상태에 빠지지 않으므로 병목 현상을 줄일 수 있음
            - 충돌 감지
                - 트랜잭션 충돌이 발생하면 예외가 발생하므로, 충돌을 즉시 감지하고 적절한 조치를 취할 수 있음
            - 읽기 작업에 최적화
                - 비관적 락에 비해서, 읽기 작업에서 락 경쟁으로 인한 지연이 없어, 읽기 성능이 향상
            - 낙관적 락의 문제점은 없을까?
                - 충돌 발생 시 예외에 대한 후처리 필요
                    - 낙관적 락은 다른 트랜잭션이 동일한 데이터를 수정했는지 확인 하고, 충돌이 확인되면 예외를 발생시킴
                    - 충돌 해결을 위한 재시도 로직이 필요, 코드의 복잡성 증가
                - 높은 충돌 비율에 대한 문제
                    - 동시에 같은 데이터를 수정하는 트랜잭션이 많은 경우, 낙관적 락을 사용 시 충돌 비율이 높아져 성능 저하 발생
                - 롤백 비용
                    - 롤백 후 재시도를 통해 충돌을 해결할 수 있지만, 재시도를 위한 리소스 및 시간이 추가로 소모됨
                    - 충돌이 빈번하게 발생한다? 비용이 적지 않을 것이다.
                - 버전 관리의 복잡성
                    - JPA 사용할 때 @Version 컬럼을 추가
        - 비관적 락(Pessimistic Lock)
            - 엔티티나 쿼리에 설정
            - @Lock 어노테이션을 통해 엔티티에 락을 걸어 다른 트랜잭션의 접근을 제어
            - 특정 데이터에 대한 동시 접근을 제한하여 충돌을 방지하고 데이터의 일관성을 유지하는데 용이
            - 많은 트랜잭션을 처리하려는 경우 성능 저하가 발생할 수 있음
                - 트랜잭션의 범위가 넓어질수록 락이 걸리는 시간이 길어짐
                - 다른 트랜잭션의 접근을 제한하기 때문에 병목 현상이 발생할 수 있음
            - 데드락 가능성
                - 둘 이상의 트랜잭션이 서로 대기하게 되면 데드락 발생
                - 예를 들어, 트랜잭션 A가 테이블 A의 레코드 1을 락을 걸고 테이블 B의 레코드 2를 락을 걸고, 서로 반대의 레코드에 접근하려고하면 데드락 상태에 빠질 수 있음
                - 데드락을 방지하기 위해 트랜잭션의 범위를 최소화하고, 트랜잭션의 범위가 넓어지는 경우 락의 순서를 정하는 것이 좋음
                - 데드락이 발생하면 트랜잭션을 롤백하고 재시도하는 방법을 사용할 수 있음
            -
- 분산 락